{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h4 class="text-primary mb-3">Manage Class Fees (Per Year/Term/Group)</h4>

  {% if year_locked %}
    <div class="alert alert-warning">
      <strong>Locked:</strong> Academic year {{ default_year }} is locked. You can view settings but cannot edit/delete.
      <a class="ms-2" href="{{ url_for('academic_years') }}">Manage locks</a>
    </div>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% set _classes  = class_options or ['Baby','Middle','Top','P1','P2','P3','P4','P5','P6','P7'] %}
  {% set _sections = section_options or ['Day','Boarding'] %}
  {% set _terms = [(1,'Term 1'),(2,'Term 2'),(3,'Term 3')] %}
  {% set _groups = fee_groups or ['Old','New'] %}

  <!-- Add / Update -->
  <form method="post" class="row g-3 border rounded p-3 shadow-sm bg-light mb-4">
    <input type="hidden" name="id" id="fee_id">

    <div class="col-md-2">
      <label class="form-label">Year <span class="text-danger">*</span></label>
      <input type="number" name="year" id="fee_year" class="form-control"
             value="{{ default_year or '' }}" required {% if year_locked %}disabled{% endif %}>
    </div>

    <div class="col-md-2">
      <label class="form-label">Term <span class="text-danger">*</span></label>
      <select name="term_no" id="fee_term_no" class="form-select" required {% if year_locked %}disabled{% endif %}>
        <option value="">-- Select --</option>
        {% for n, lbl in _terms %}
          <option value="{{ n }}" {{ 'selected' if (default_term_no|string)==(n|string) else '' }}>{{ lbl }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Fee Group <span class="text-danger">*</span></label>
      <select name="fee_group" id="fee_group" class="form-select" required {% if year_locked %}disabled{% endif %}>
        {% for g in _groups %}
          <option value="{{ g }}" {{ 'selected' if default_fee_group==g else '' }}>{{ g }}</option>
        {% endfor %}
      </select>
      <div class="small text-muted">New = students joining this year</div>
    </div>

    <div class="col-md-2">
      <label class="form-label">Class <span class="text-danger">*</span></label>
      <select name="class_name" id="fee_class_name" class="form-select" required {% if year_locked %}disabled{% endif %}>
        <option value="">-- Select --</option>
        {% for c in _classes %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Section <span class="text-danger">*</span></label>
      <select name="section" id="fee_section" class="form-select" required {% if year_locked %}disabled{% endif %}>
        <option value="">-- Select --</option>
        {% for s in _sections %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Amount (UGX) <span class="text-danger">*</span></label>
      <input type="number" step="0.01" name="amount" id="fee_amount" class="form-control" required {% if year_locked %}disabled{% endif %}>
    </div>

    <div class="col-md-6">
      <label class="form-label">Level (optional)</label>
      <input type="text" name="level" id="fee_level" class="form-control"
             placeholder="Nursery / Primary / Secondary" {% if year_locked %}disabled{% endif %}>
    </div>

    <div class="col-12 text-end">
      <button type="submit" class="btn btn-primary" {% if year_locked %}disabled{% endif %}>Save Fee</button>
      <button type="button" class="btn btn-outline-secondary" onclick="resetFeeForm()" {% if year_locked %}disabled{% endif %}>Clear</button>
      <a class="btn btn-primary" href="{{ url_for('bursaries') }}">Manage Bursaries</a>
      <a class="btn btn-primary" href="{{ url_for('admin_requirements') }}">Manage Requirements</a>
      <a class="btn btn-primary" href="{{ url_for('dashboard') }}">← Back</a>
    </div>
  </form>

  <!-- Filters -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
      <label class="form-label">Year</label>
      <input type="number" name="year" class="form-control" value="{{ q_year or '' }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">Term</label>
      <select name="term_no" class="form-select">
        {% for n, lbl in _terms %}
          <option value="{{ n }}" {{ 'selected' if (q_term_no|string)==(n|string) else '' }}>{{ lbl }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Fee Group</label>
      <select name="fee_group" class="form-select">
        {% for g in _groups %}
          <option value="{{ g }}" {{ 'selected' if q_fee_group==g else '' }}>{{ g }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 d-flex align-items-end justify-content-end">
      <button class="btn btn-outline-primary">Filter</button>
    </div>
  </form>

  <!-- Fees List -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>Year</th>
          <th>Term</th>
          <th>Group</th>
          <th>Class</th>
          <th>Section</th>
          <th>Level</th>
          <th>Amount (UGX)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for f in fees %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ f.year }}</td>
          <td>Term {{ f.term_no }}</td>
          <td>{{ f.fee_group }}</td>
          <td>{{ f.class_name }}</td>
          <td>{{ f.section }}</td>
          <td>{{ f.level or '—' }}</td>
          <td>{{ "{:,.0f}".format(f.amount or 0) }}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary"
              {% if year_locked %}disabled{% endif %}
              onclick="fillFeeEdit(
                {{ f.id }},
                '{{ f.class_name }}',
                '{{ f.section }}',
                '{{ (f.level or '')|e }}',
                {{ f.amount or 0 }},
                {{ f.year or 0 }},
                {{ f.term_no or 1 }},
                '{{ f.fee_group or 'Old' }}'
              )">Edit</button>

            <form method="post"
                  action="{{ url_for('delete_class_fee', fee_id=f.id) }}"
                  onsubmit="return confirm('Delete this fee?');"
                  class="d-inline">
              <button class="btn btn-sm btn-outline-danger" {% if year_locked %}disabled{% endif %}>Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="text-center">No class fees set yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function fillFeeEdit(id, cls, section, level, amount, year, termNo, feeGroup) {
  document.getElementById('fee_id').value = id;
  document.getElementById('fee_class_name').value = cls || '';
  document.getElementById('fee_section').value = section || '';
  document.getElementById('fee_level').value = level || '';
  document.getElementById('fee_amount').value = amount || 0;
  document.getElementById('fee_year').value = year || '';
  document.getElementById('fee_term_no').value = termNo || '';
  document.getElementById('fee_group').value = feeGroup || 'Old';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetFeeForm() {
  document.getElementById('fee_id').value = '';
  document.getElementById('fee_class_name').value = '';
  document.getElementById('fee_section').value = '';
  document.getElementById('fee_level').value = '';
  document.getElementById('fee_amount').value = '';
}
</script>
{% endblock %}
