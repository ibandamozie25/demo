
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="text-primary m-0">Manage Bursaries</h4>
    <div class="d-flex gap-2">
      <a class="btn btn-success"
         href="{{ url_for('bursaries_export', year=q_year, term=q_term, student_number=q_sn, last_name=q_ln) }}">
        Export CSV
      </a>
	  
	 <!-- <a class="btn btn-outline-secondary" href="{{ url_for('bursaries_sample') }}">
        Sample CSV-->
      </a>	 
      <form method="post" action="{{ url_for('bursaries_import') }}" enctype="multipart/form-data" class="d-inline-flex gap-2">
        <input type="file" name="file" accept=".csv,.xlsx,.xls" class="form-control form-control-sm" required>
        <button class="btn btn-primary btn-sm">Import</button>
      </form>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Add bursary -->
  <form method="post" class="border rounded p-3 shadow-sm bg-light mb-3">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Student Number</label>
        <input name="student_number" class="form-control" placeholder="e.g. P7-2025-0001"
               value="{{ request.args.get('student_number','') }}">
        <div class="form-text">Or search by Last Name</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Last Name</label>
        <input name="last_name" class="form-control" placeholder="e.g. Okello"
               value="{{ request.args.get('last_name','') }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Year</label>
        <input name="year" class="form-control" value="{{ default_year }}" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Sponsor</label>
        <input name="sponsor_name" class="form-control" placeholder="PTA / Donor / Parent" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Amount (UGX)</label>
        <input type="number" step="0.01" name="amount" class="form-control" required>
      </div>

      <div class="col-md-9">
        <label class="form-label d-block">Apply To</label>

        <!-- One term -->
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="apply_to" id="ap_one" value="one" checked>
          <label class="form-check-label" for="ap_one">One Term</label>
        </div>
        <select name="term_one" id="term_one" class="form-select d-inline-block w-auto ms-2 align-middle">
          <option value="">-- Choose Term --</option>
          {% for t in terms %}
            <option value="{{ t }}">{{ t }}</option>
          {% endfor %}
        </select>

        <!-- Two terms (pair) -->
        <div class="form-check form-check-inline ms-4">
          <input class="form-check-input" type="radio" name="apply_to" id="ap_two" value="two">
          <label class="form-check-label" for="ap_two">Two Terms</label>
        </div>
        <select name="term_pair" id="term_pair" class="form-select d-inline-block w-auto ms-2 align-middle" style="display:none;">
          <option value="">-- Choose Pair --</option>
          <option value="t1_t2">Term 1 and Term 2</option>
          <option value="t1_t3">Term 1 and Term 3</option>
          <option value="t2_t3">Term 2 and Term 3</option>
        </select>

        <!-- Whole year -->
        <div class="form-check form-check-inline ms-4">
          <input class="form-check-input" type="radio" name="apply_to" id="ap_year" value="year">
          <label class="form-check-label" for="ap_year">Whole Year (all 3)</label>
        </div>
      </div>

      <div class="col-12 text-end">
        <button class="btn btn-primary">Save Bursary</button>
		<a class="btn btn-primary" href="{{ url_for('admin_class_fees') }}">
         ← Back
		 </a>
      </div>
    </div>
  </form>

  <!-- Filters -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-md-2">
      <label class="form-label">Year</label>
      <input name="year" class="form-control" value="{{ q_year }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Term</label>
      <select name="term" class="form-select">
        <option value="">All</option>
        {% for t in terms %}
          <option value="{{ t }}" {{ 'selected' if q_term==t else '' }}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Student Number</label>
      <input name="student_number" class="form-control" value="{{ q_sn }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">Last Name</label>
      <input name="last_name" class="form-control" value="{{ q_ln }}">
    </div>
    <div class="col-12 text-end">
      <button class="btn btn-outline-primary">Filter</button>
    </div>
  </form>

  <!-- List -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Student No.</th>
          <th>Class</th>
          <th>Term</th>
          <th>Year</th>
          <th>Sponsor</th>
          <th>Amount (UGX)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bursaries %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ b.first_name }} {{ b.middle_name or '' }} {{ b.last_name }}</td>
          <td>{{ b.student_number }}</td>
          <td>{{ b.class_name }} {{ b.stream }}</td>
          <td>{{ b.term }}</td>
          <td>{{ b.year }}</td>
          <td>{{ b.sponsor_name or '—' }}</td>
          <td>{{ "{:,.0f}".format(b.amount or 0) }}</td>
          <td class="text-nowrap">
            <!-- Edit -->
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editB{{ b.id }}">Edit</button>

            <!-- Delete -->
            <form method="post" action="{{ url_for('delete_bursary', bid=b.id) }}" class="d-inline"
                  onsubmit="return confirm('Delete this bursary entry?');">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>

            <!-- Edit Modal -->
            <div class="modal fade" id="editB{{ b.id }}" tabindex="-1" aria-labelledby="editBLabel{{ b.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <form method="post" action="{{ url_for('update_bursary', bid=b.id) }}" class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="editBLabel{{ b.id }}">Edit Bursary – {{ b.first_name }} {{ b.last_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-2">
                      <label class="form-label">Sponsor (optional)</label>
                      <input name="sponsor_name" class="form-control" value="{{ b.sponsor_name or '' }}">
                    </div>
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label">Amount (UGX)</label>
                        <input type="number" step="0.01" name="amount" class="form-control" value="{{ b.amount or 0 }}" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Year</label>
                        <input name="year" class="form-control" value="{{ b.year }}" required>
                      </div>
                    </div>
                    <div class="mt-2">
                      <label class="form-label">Term</label>
                      <select name="term" class="form-select" required>
                        {% for t in terms %}
                          <option value="{{ t }}" {{ 'selected' if b.term==t else '' }}>{{ t }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>

          </td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="text-center">No bursaries found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Toggle which select appears for apply_to -->
<script>
(function () {
  function syncApplyTo() {
    const apOne = document.getElementById('ap_one');
    const apTwo = document.getElementById('ap_two');
    const apYear = document.getElementById('ap_year');
    const termOne = document.getElementById('term_one');
    const termPair = document.getElementById('term_pair');

    if (apOne.checked) {
      termOne.style.display = 'inline-block';
      termPair.style.display = 'none';
      termPair.value = '';
    } else if (apTwo.checked) {
      termOne.style.display = 'none';
      termOne.value = '';
      termPair.style.display = 'inline-block';
    } else if (apYear.checked) {
      termOne.style.display = 'none';
      termOne.value = '';
      termPair.style.display = 'none';
      termPair.value = '';
    }
  }

  ['ap_one','ap_two','ap_year'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', syncApplyTo);
  });
  syncApplyTo();
})();
</script>
{% endblock %}
