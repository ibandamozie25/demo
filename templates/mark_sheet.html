
{% extends "base.html" %}
{% block title %}Mark Sheet {{ class_name }} {{ stream }} – {{ term }} {{ year }}{% endblock %}

{% block content %}
<div class="report-header" style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
  <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo" style="height:44px;">
  <div>
    <h2 style="margin:0; font-size:1.05rem;">{{ school_title }}</h2>
    <div style="font-size:0.88rem;">Mark Sheet {{ class_name }} {{ stream }} — {{ term }} {{ year }}</div>
  </div>

  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <form method="get" action="{{ url_for('mark_sheet') }}" style="display:flex; gap:6px; align-items:center;">
      <select name="class_name">
        {% for c in ["Baby","Middle","Top","P1","P2","P3","P4","P5","P6","P7"] %}
          <option value="{{ c }}" {{ "selected" if c==class_name else "" }}>{{ c }}</option>
        {% endfor %}
      </select>
		<select name="stream" class="form-select form-select-sm">
		  <option value="" {% if not stream %}selected{% endif %}>All streams</option>
		  {% for s in streams %}
			<option value="{{ s }}" {% if s == stream %}selected{% endif %}>
			  {{ s or 'No stream' }}
			</option>
		  {% endfor %}
		</select>
      <select name="term">
        {% for t in ["Term 1","Term 2","Term 3"] %}
          <option value="{{ t }}" {{ "selected" if t==term else "" }}>{{ t }}</option>
        {% endfor %}
      </select>
      <input type="number" name="year" value="{{ year }}" style="width:78px;">
      <button type="submit" class="btn btn-sm btn-secondary">Apply</button>
    </form>

    <!-- Export PDF as a button (keeps current filters) -->
	<a class="btn btn-primary btn-sm" href="{{ url_for('performance_summary') }}">&larr; Back</a>
    <a class="btn btn-sm btn-primary"
       href="{{ url_for('mark_sheet_pdf_reportlab',
                        class_name=class_name,
                        stream=stream,
                        term=term,
                        year=year) }}">
      Export PDF
    </a>
  </div>
</div>

<div class="table-wrap" style="overflow:auto;">
  <table class="table table-striped table-bordered" style="width:100%; font-size:0.82rem; table-layout:fixed;">
    <!-- Compact, predictable column widths -->
    <colgroup>
      <col style="width:20px;"> <!-- No. -->
      <col style="width:50px;"> <!-- Student No. -->
      <col style="width:100px;"> <!-- Name -->
      {% for s in subjects %}
        <col style="width:64px;"> <!-- each subject -->
      {% endfor %}
      <col style="width:30px;"> <!-- Total -->
      <col style="width:30px;"> <!-- AVE -->
      <col style="width:30px;"> <!-- AGG -->
      <col style="width:30px;"> <!-- DIV -->
      <col style="width:30px;"> <!-- POS -->
    </colgroup>

    <thead>
      <tr>
        <th class="text-center">No.</th>
        <th class="text-center">Student No.</th>
        <th class="text-start">Name</th>
        {% for s in subjects %}
          <th class="text-center" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            {{ (s.code or s.name) }}<br><small>mark&nbsp;(gr)</small>
          </th>
        {% endfor %}
        <th class="text-end">Total</th>
        <th class="text-end">AVE</th>
        <th class="text-center">AGG</th>
        <th class="text-center">DIV</th>
        <th class="text-center">POS</th>
      </tr>
    </thead>

    <tbody>
      {% for r in rows %}
        <tr>
          <td class="text-center">{{ r.no }}</td>
          <td class="text-center">{{ r.student_number }}</td>
          <td class="text-start" style="overflow:hidden; text-overflow:ellipsis;">{{ r.full_name }}</td>

          {% for c in r.cells %}
            <td class="text-center" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              {{ c.text }}
            </td>
          {% endfor %}

          <td class="text-end">{{ "%.0f"|format(r.total) }}</td>
          <td class="text-end">{{ "%.1f"|format(r.ave) }}</td>
          <td class="text-center">{{ r.agg }}</td>
          <td class="text-center">{{ r.div }}</td>
          <td class="text-center">{{ r.pos }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
